version: 0.2

phases:
  install:
    commands:
      - echo Installing dependencies...

  pre_build:
    commands:
      - echo "Checking the latest commit for changes in Node.js or Python directory..."
      
      # Get the latest commit hash
      - LATEST_COMMIT=$(git rev-parse HEAD)
      
      # Get the list of files changed in the latest commit
      - CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $LATEST_COMMIT)
      
      # Check if any files in the Node.js directory were changed
      - |
        if echo "$CHANGED_FILES" | grep -q "^nodejs-hello-world"; then
          echo "Node.js directory has changes. Running Node.js build...";
          export RUN_NODEJS=true;
        fi
        
      # Check if any files in the Python directory were changed
      - |
        if echo "$CHANGED_FILES" | grep -q "^python-hello-world"; then
          echo "Python directory has changes. Running Python build...";
          export RUN_PYTHON=true;
        fi

  build:
    commands:
      - echo "Starting build..."
      
      # If Node.js directory has changes, run the Node.js build steps
      - |
        if [ "$RUN_NODEJS" = "true" ]; then
          echo "Building Node.js app...";
          cd nodejs-hello-world;
          docker build -t nodejs-hello-world .;
        fi

      # If Python directory has changes, run the Python build steps
      - |
        if [ "$RUN_PYTHON" = "true" ]; then
          echo "Building Python app...";
          cd python-hello-world;
          docker build -t python-hello-world .;
        fi

  post_build:
    commands:
      - echo Build completed.

artifacts:
  files:
    - '**/*'
